var e={d:(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{qE:()=>g,EK:()=>L,KU:()=>a,kE:()=>h,UA:()=>w,ID:()=>i,Mk:()=>v,t9:()=>A,mx:()=>M,E9:()=>o,h_:()=>b,$E:()=>y,mi:()=>s,yN:()=>d,Tk:()=>r,zW:()=>f,VJ:()=>l,Jh:()=>x,TG:()=>n,Rd:()=>u,I3:()=>B,mj:()=>c,yr:()=>p,Lt:()=>R,q3:()=>O,dv:()=>N});class i{constructor(e,t){this.className=e,this.id=t}toString(){return this.className+" "+this.id}}class s{constructor(){this.x=0,this.y=1,this.z=0,this.angle=0}}class o{constructor(){this.x=0,this.y=0,this.z=0}}class n{constructor(){this.id=null,this.position=null,this.rotation=null,this.scale=null,this.permanent=!1,this.mesh=null,this.active=!1,this.streamId=null,this.script=null,this.properties=null,this.listeners=[],this.VRSPACE=null,this.className="VRObject"}addListener(e){this.listeners.push(e)}removeListener(e){var t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}notifyListeners(e){for(var t=0;t<this.listeners.length;t++)this.listeners[t](this,e)}publish(){if(!this.VRSPACE)throw"the object is not shared yet";let e=new l(this);for(var t in this)"id"!==t&&"VRSPACE"!==t&&(e.changes[t]=this[t]);let i=JSON.stringify(e);this.VRSPACE.log(i),this.VRSPACE.send(i)}}class r{constructor(){this.range=2e3,this.resolution=10,this.size=1e3,this.timeout=3e4}}class a extends n{constructor(){super(),this.name=null,this.sceneProperties=null,this.leftArmPos={x:null,y:null,z:null},this.rightArmPos={x:null,y:null,z:null},this.leftArmRot={x:null,y:null,z:null,w:null},this.rightArmRot={x:null,y:null,z:null,w:null},this.userHeight=1.8,this.token=null,this.className="Client"}hasAvatar(){return this.mesh&&this.mesh.toLowerCase().endsWith(".gltf")}}class h extends a{constructor(){super(),this.className="EventRecorder"}}class l{constructor(e,t){this.object=new Object,this.object[e.className]=e.id,this.changes=t||new Object}}class d{constructor(e,t,i,s,o){this.className=t,this.objectId=i,this.added=s,this.removed=o,this.scene=e}}class c{constructor(){for(var e in this.ws=null,this.me=null,this.scene=new Map,this.debug=!1,this.connectionListeners=[],this.dataListeners=[],this.sceneListeners=[],this.welcomeListeners=[],this.errorListeners=[],this.responseListener=null,this.sharedClasses={ID:i,Rotation:s,Point:o,VRObject:n,SceneProperties:r,Client:a,VREvent:l,SceneEvent:d,EventRecorder:h},this.sharedClasses)this[e]=this.sharedClasses[e]}log(e){this.debug&&console.log(e)}addListener(e,t){"function"==typeof t&&e.push(t)}removeListener(e,t){var i=e.indexOf(t);i>-1&&e.splice(i,1)}addConnectionListener(e){this.addListener(this.connectionListeners,e)}addDataListener(e){this.addListener(this.dataListeners,e)}addSceneListener(e){this.addListener(this.sceneListeners,e)}removeSceneListener(e){this.removeListener(this.sceneListeners,e)}addWelcomeListener(e){this.addListener(this.welcomeListeners,e)}removeWelcomeListener(e){this.removeListener(this.welcomeListeners,e)}addErrorListener(e){this.addListener(this.errorListeners,e)}getScene(e){if(void 0===e)return this.scene;if("string"==typeof e){var t=new Map;for(const[i,s]of this.scene)i.startsWith(e)&&t.set(i,s);return t}}connect(e){if(!e){e=window.location.href,this.log("This href "+e);let t=e.indexOf("/"),i="ws";"https:"==e.substring(0,t)&&(i="wss");let s=e.indexOf("/",t+2);e=i+":"+e.substring(t,s)+"/vrspace"}this.log("Connecting to "+e),this.ws=new WebSocket(e),this.ws.onopen=()=>{this.connectionListeners.forEach((e=>e(!0)))},this.ws.close=()=>{this.connectionListeners.forEach((e=>e(!1)))},this.ws.onmessage=e=>{this.receive(e.data),this.dataListeners.forEach((t=>t(e.data)))},this.log("Connected!")}disconnect(){null!=this.ws&&this.ws.close(),this.connectionListeners.forEach((e=>e(!1))),this.log("Disconnected")}stringifyVector(e){return'{"x":'+e.x+',"y":'+e.y+',"z":'+e.z+"}"}stringifyQuaternion(e){return'{"x":'+e.x+',"y":'+e.y+',"z":'+e.z+',"w":'+e.w+"}"}stringifyPair(e,t){return"string"==typeof t?'"'+e+'":"'+t+'"':"object"==typeof t?t.hasOwnProperty("w")?'"'+e+'":'+this.stringifyQuaternion(t):t.hasOwnProperty("x")||t.hasOwnProperty("_x")?'"'+e+'":'+this.stringifyVector(t):'"'+e+'":'+JSON.stringify(t):"number"==typeof t||"boolean"==typeof t?'"'+e+'":'+t:(console.log("Unsupported datatype "+typeof t+", ignored user event "+e+"="+t),"")}createField(e,t,i){this.call('{"command":{"Describe":{"className":"'+e+'"}}}',(s=>{var o=null;for(var n in s.response)if(n===t){var r=s.response[n];o="String"===r?"":"Long"==r||"Double"==r?0:new this.newInstance(e);break}i(o)}))}createSharedObject(e,t,s){s||(s=e.className?e.className:"VRObject");let o=JSON.stringify(e);this.log(o),this.call('{"command":{"Add":{"objects":[{"'+s+'":'+o+"}]}}}",(e=>{this.log("Response:",e);var o=e.response[0][s];const n=new i(s,o);this.log("Created object:"+o);var r=this.scene.get(n.toString());t(r)}))}deleteSharedObject(e,t){this.call('{"command":{"Remove":{"objects":[{"'+e.className+'":'+e.id+"}]}}}",(i=>{t&&t(e)}))}sendMy(e,t){null!=this.me?this.send('{"object":{"Client":'+this.me.id+'},"changes":{'+this.stringifyPair(e,t)+"}}"):this.log("No my ID yet, ignored user event "+e+"="+t)}sendCommand(e,t){t?this.send('{"command":{"'+e+'":'+JSON.stringify(t)+"}}"):this.send('{"command":{"'+e+'":{}}}')}sendChanges(e,t){if(t&&0!=t.length){var i=0,s='{"object":{"'+e.className+'":'+e.id+'},"changes":{';t.forEach((e=>{s+=this.stringifyPair(e.field,e.value),++i<t.length&&(s+=",")})),s+="}}",this.send(s)}}sendEvent(e,t){if(t&&0!=t.length){var i=0,s='{"object":{"'+e.className+'":'+e.id+'},"changes":{';for(var o in t)s+=this.stringifyPair(o,t[o]),++i<t.length&&(s+=",");s+="}}",this.send(s)}}sendMyChanges(e){if(null==this.me)throw this.log("No my ID yet, user event ignored:"),this.log(e),"No my ID yet, user event ignored:";this.sendChanges(this.me,e)}send(e){this.log("Sending message: "+e),this.ws.send(e)}call(e,t){this.responseListener=t,this.send(e)}newInstance(e){return this.sharedClasses[e]?new this.sharedClasses[e]:(console.log("Unknown object type: "+e),null)}addToScene(e,t){var s=this.newInstance(e);if(s){Object.assign(s,t),s.VRSPACE=this;var o=new i(e,t.id);this.scene.set(o.toString(),s);const n=new d(this.scene,e,o,s,null);this.sceneListeners.forEach((e=>e(n)))}}addObject(e){var t=Object.keys(e)[0],i=Object.values(e)[0];this.addToScene(t,i)}removeObject(e){const t=new i(Object.keys(e)[0],Object.values(e)[0]),s=this.scene.get(t.toString()),o=this.scene.delete(t.toString());this.log("deleted "+this.scene.size+" "+t+":"+o);const n=new d(this.scene,t.className,t,null,s);this.sceneListeners.forEach((e=>e(n)))}processEvent(e,t){var s=new i(Object.keys(e)[0],Object.values(e)[0]);if(this.log("processing changes on "+s),this.scene.has(s.toString())){var o=this.scene.get(s.toString());Object.assign(o,t),o.notifyListeners(t)}else this.log("Unknown object "+s)}receive(e){this.log("Received: "+e);var t=JSON.parse(e);if("object"in t)this.processEvent(t.object,t.changes);else if("Add"in t){for(i=0;i<t.Add.objects.length;i++)this.addObject(t.Add.objects[i]);this.log("added "+t.Add.objects.length+" scene size "+this.scene.size)}else if("Remove"in t)for(var i=0;i<t.Remove.objects.length;i++)this.removeObject(t.Remove.objects[i]);else if("ERROR"in t)this.log(t.ERROR),this.errorListeners.forEach((e=>e(t.ERROR)));else if("Welcome"in t){var s=t.Welcome;if(this.log("welcome "+s.client.id),!this.me){let e=new a;this.me=Object.assign(e,s.client)}this.welcomeListeners.forEach((e=>e(s)))}else if("response"in t){if(this.log("Response to command"),"function"==typeof this.responseListener){var o=this.responseListener;this.responseListener=null,o(t)}}else this.log("ERROR: unknown message type")}}const u=new c;class g{constructor(e,t,i){this.scene=e,this.folder=t,this.shadowGenerator=i,this.mirror=!0,this.fps=10,this.userHeight=1.8,this.groundHeight=0,this.fixes=null,this.animateArms=!0,this.info=null,this.body={},this.skeleton=null,this.bonesTotal=0,this.bonesProcessed=[],this.bonesDepth=0,this.animationTargets=[],this.character=null,this.activeAnimation=null,this.rootMesh=null,this.debug=!1,this.debugViewer1,this.debugViewer2}createBody(){this.bonesTotal=0,this.bonesProcessed=[],this.bonesDepth=0,this.neckQuat=null,this.neckQuatInv=null,this.headQuat=null,this.headQuatInv=null,this.body={processed:!1,root:null,hips:null,leftLeg:{upper:null,lower:null,foot:[]},rightLeg:{upper:null,lower:null,foot:[]},spine:[],leftArm:{side:"left",frontAxis:null,sideAxis:null,shoulder:null,upper:null,upperRot:null,lower:null,lowerRot:null,hand:null,handRot:null,fingers:{thumb:[],index:[],middle:[],ring:[],pinky:[]}},rightArm:{side:"right",frontAxis:null,sideAxis:null,shoulder:null,upper:null,upperRot:null,lower:null,lowerRot:null,hand:null,handRot:null,fingers:{thumb:[],index:[],middle:[],ring:[],pinky:[]}},neck:{neck:null,head:null,lefEye:null,rightEye:null}}}log(e){this.debug&&console.log(e)}boneProcessed(e){this.bonesProcessed.includes(e.name)?this.log("Already processed bone "+e.name):(this.bonesTotal++,this.bonesProcessed.push(e.name))}dispose(){this.character.dispose(),this.debugViewer1&&this.debugViewer1.dispose(),this.debugViewer2&&this.debugViewer2.dispose()}replace(e){return e&&e.dispose(),this}_processContainer(e,t){this.character=e;var i=e.meshes;this.rootMesh=i[0],this.animationTargets=[],e.animationGroups&&e.animationGroups.length>0&&e.animationGroups[0].stop(),this.animationTargets.sort(((e,t)=>e.localeCompare(t,void 0,{sensitivity:"base"})));var s=this.rootMesh.getHierarchyBoundingVectors();this.log("Bounding box:"),this.log(s);var o=this.userHeight/(s.max.y-s.min.y);this.log("Scaling: "+o),this.rootMesh.scaling=new BABYLON.Vector3(o,o,o),e.addAllToScene(),this.castShadows(this.shadowGenerator),s=this.rootMesh.getHierarchyBoundingVectors(),this.groundLevel(-s.min.y),e.skeletons&&e.skeletons.length>0?(this.skeleton=e.skeletons[0],this.createBody(),this.skeleton.computeAbsoluteTransforms(),this.skeleton.name=this.folder.name,this.processBones(this.skeleton.bones),this.log("Head position: "+this.headPos()),this.initialHeadPos=this.headPos(),this.resize(),this.bonesProcessed.sort(((e,t)=>e.localeCompare(t,void 0,{sensitivity:"base"}))),this.calcLength(this.body.leftArm),this.calcLength(this.body.rightArm),this.calcLength(this.body.leftLeg),this.calcLength(this.body.rightLeg),this.guessArmsRotations(),this.guessLegsRotations(),this.body.processed=!0,(this.debugViewier1||this.debugViewer2)&&this.scene.registerBeforeRender((function(){this.debugViewer1&&this.debugViewer1.update(),this.debugViewer2&&this.debugViewer2.update()}))):console.log("NOT an avatar - no skeletons"),this.fixes&&void 0!==this.fixes.standing&&(this.log("Applying fixes for: "+this.folder.name+" standing: "+this.fixes.standing),this.groundLevel(this.fixes.standing)),t&&t(this)}async loadFixes(){if(this.folder.related)return this.log("Loading fixes from "+this.folder.baseUrl+"/"+this.folder.related),fetch(this.folder.baseUrl+"/"+this.folder.related,{cache:"no-cache"}).then((e=>e.json())).then((e=>{this.fixes=e,this.log("Loaded fixes: "),this.log(e)}))}sliceGroup(e,t,i){for(var s=new BABYLON.AnimationGroup(e.name+":"+t+"-"+i),o=0;o<e.targetedAnimations.length;o++){var n=this.sliceAnimation(e.targetedAnimations[o].animation,t,i);n.getKeys().length>0&&s.addTargetedAnimation(n,e.targetedAnimations[o].target)}return s}sliceAnimation(e,t,i){for(var s=e.getKeys(),o=[],n=0;n<s.length;n++){var r=s[n];if(r.frame>=t){if(!(r.frame<=i))break;o.push(r)}}var a=new BABYLON.Animation(e.name,e.targetProperty,e.framePerSecond,e.dataType,e.enableBlending);return a.loopMode=e.loopMode,a.setKeys(o),a}getAnimationGroups(){if(!this.animationGroups){var e=!0;if(this.fixes&&void 0!==this.fixes.loopAnimations&&(e=this.fixes.loopAnimations),this.fixes&&this.fixes.animationGroups){this.animationGroups=[];for(var t=0;t<this.fixes.animationGroups.length;t++)for(var i=this.fixes.animationGroups[t],s=0;s<this.character.animationGroups.length;s++){var o=this.character.animationGroups[s];if(o.name==i.source){var n=o;(i.start||i.end)&&(n=this.sliceGroup(o,i.start,i.end)),i.name&&(n.name=i.name),void 0!==i.loop?n.loopAnimation=i.loop:n.loopAnimation=e,this.animationGroups.push(n);break}}}else for(this.animationGroups=this.character.animationGroups,s=0;s<this.animationGroups.length;s++)this.animationGroups[s].loopAnimation=e}return this.animationGroups}getUrl(){return this.folder.url()+"/scene.gltf"}load(e,t,i){this.loadFixes().then((()=>{this.log("loading from "+this.folder.url());var i=this,s=BABYLON.SceneLoader.LoadAssetContainer(this.folder.baseUrl+this.folder.name+"/","scene.gltf",this.scene,(t=>i._processContainer(t,e)),(e=>{t&&t(e)}));return s.onParsedObservable.add((e=>{var t=e.json;i.info=t.asset.extras})),s}))}headPos(){return this.skeleton.bones[this.body.head].getAbsolutePosition().scale(this.rootMesh.scaling.x).add(this.rootMesh.position)}absVector(e){var t=new BABYLON.Vector3;return t.x=Math.abs(e.x),t.y=Math.abs(e.y),t.z=Math.abs(e.z),t}roundVector(e){e.x=Math.round(e.x),e.y=Math.round(e.y),e.z=Math.round(e.z)}lookAt(e){var t=this.skeleton.bones[this.body.head],i=new BABYLON.Vector3(e.x,e.y,e.z).subtract(this.rootMesh.position);i.rotateByQuaternionToRef(BABYLON.Quaternion.Inverse(this.rootMesh.rotationQuaternion),i);var s=i.subtract(this.headPos()).add(this.rootMesh.position);-1==this.headAxisFix&&(s.y=-s.y),s.rotateByQuaternionToRef(this.headQuatInv,s);var o=new BABYLON.Matrix;BABYLON.Matrix.RotationAlignToRef(this.headTarget,s.normalizeToNew(),o);var n=BABYLON.Quaternion.FromRotationMatrix(o);if(1!=this.headAxisFix){var r=this.headQuat.multiply(this.neckQuatInv);n=n.multiply(r)}t.getTransformNode().rotationQuaternion=n}thirdAxis(e){return new BABYLON.Vector3(1,1,1).subtract(e.frontAxis.axis).subtract(e.sideAxis.axis)}drawVector(e,t){BABYLON.MeshBuilder.CreateLines("vector-"+e+"-"+t,{points:[e,t]},this.scene)}reachFor(e,t){var i=this.skeleton.bones[e.upper],s=this.skeleton.bones[e.lower],o=this.skeleton.bones[e.hand],n=this.character.meshes[0].scaling.x,r=i.getAbsolutePosition().scale(n).subtract(this.rootMesh.position),a=s.getAbsolutePosition().scale(n).subtract(this.rootMesh.position),h=(o.getAbsolutePosition().scale(n).subtract(this.rootMesh.position),BABYLON.Quaternion.Inverse(this.rootMesh.rotationQuaternion));if(e.upperQuat)var l=e.upperQuat,d=e.armVector,c=e.worldQuat,u=e.worldQuatInv;else c=BABYLON.Quaternion.FromRotationMatrix(i.getWorldMatrix().getRotationMatrix()),e.worldQuat=c,this.log("Arm angles: "+c.toEulerAngles()),u=BABYLON.Quaternion.Inverse(c),e.worldQuatInv=u,l=i.getRotationQuaternion(),e.upperQuat=l,(d=a.subtract(r)).rotateByQuaternionToRef(u,d),e.armVector=d;var g=new BABYLON.Vector3(t.x,t.y,t.z).subtract(this.rootMesh.position);g.rotateByQuaternionToRef(h,g);var m=g.subtract(r).subtract(this.rootMesh.position);if(m.rotateByQuaternionToRef(u,m),e.pointerQuat){var p=new BABYLON.Vector3(0,-1,0),B=new BABYLON.Matrix;BABYLON.Matrix.RotationAlignToRef(d.normalizeToNew(),p.normalizeToNew(),B);var A=BABYLON.Quaternion.FromRotationMatrix(B);(isNaN(A.x)||isNaN(!A.y)||isNaN(!A.z)||isNaN(!A.y))&&(this.log("arm vector: "+d+"down vector: "+p+" quat: "+A+" rot: "),this.log(B),A=BABYLON.Quaternion.FromEulerAngles(0,0,Math.PI)),d.rotateByQuaternionToRef(A,p);var b=e.pointerQuat.multiply(h);this.mirror&&(b.y=-b.y,b.z<0&&(b.z=0));var f=new BABYLON.Vector3;p.rotateByQuaternionToRef(b,f);var v=new BABYLON.Vector3;f.rotateByQuaternionToRef(u,v);var y=new BABYLON.Matrix;BABYLON.Matrix.RotationAlignToRef(d.normalizeToNew(),v.normalizeToNew(),y);var w=new BABYLON.Matrix;BABYLON.Matrix.RotationAlignToRef(v.normalizeToNew(),m.normalizeToNew(),w);var L=y.multiply(w)}else L=new BABYLON.Matrix,BABYLON.Matrix.RotationAlignToRef(d.normalizeToNew(),m.normalizeToNew(),L);var x=BABYLON.Quaternion.FromRotationMatrix(L);e.upperRot=l.multiply(x);var O=m.length();return this.bendArm(e,O),this.renderArmRotation(e),x}renderArmRotation(e){var t=this.skeleton.bones[e.upper],i=this.skeleton.bones[e.lower];if(!this.animateArms)return t.getTransformNode().rotationQuaternion=e.upperRot,void(i.getTransformNode().rotationQuaternion=e.lowerRot);if(!e.animation){var s=this.folder.name+"-"+e.side,o=new BABYLON.AnimationGroup(s+"ArmAnimation"),n=this._createArmAnimation(s+"-upper"),r=this._createArmAnimation(s+"-lower");o.addTargetedAnimation(n,this.skeleton.bones[e.upper].getTransformNode()),o.addTargetedAnimation(r,this.skeleton.bones[e.lower].getTransformNode()),e.animation=o}this._updateArmAnimation(t,e.animation.targetedAnimations[0],e.upperRot),this._updateArmAnimation(i,e.animation.targetedAnimations[1],e.lowerRot),e.animation.isPlaying&&e.animation.stop(),e.animation.play(!1)}_createArmAnimation(e){var t=new BABYLON.Animation(e,"rotationQuaternion",this.fps,BABYLON.Animation.ANIMATIONTYPE_QUATERNION,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),i=[];return i.push({frame:0,value:0}),i.push({frame:1,value:0}),t.setKeys(i),t}_updateArmAnimation(e,t,i){t.animation.getKeys()[0].value=e.getTransformNode().rotationQuaternion,t.animation.getKeys()[1].value=i}bendArm(e,t){var i=!0;this.skeleton.bones[e.upper],this.skeleton.bones[e.lower],this.rootMesh.scaling.x,t>e.lowerLength+e.upperLength&&(t=e.lowerLength+e.upperLength,i=!1);var s=(e.lowerLength+e.upperLength)/2,o=Math.asin(t/2/s),n=Math.PI/2-o,r=2*n,a=BABYLON.Quaternion.RotationAxis(e.frontAxis.axis,-n*e.frontAxis.sign);return e.upperRot=e.upperRot.multiply(a),e.lowerRot=BABYLON.Quaternion.RotationAxis(e.frontAxis.axis,r*e.frontAxis.sign),i}legLength(){return(this.body.leftLeg.upperLength+this.body.leftLeg.lowerLength+this.body.rightLeg.upperLength+this.body.rightLeg.lowerLength)/2}setPosition(e){this.rootMesh.position.x=e.x,this.groundLevel(e.y),this.rootMesh.position.z=e.z}setRotation(e){this.rootMesh.rotationQuaternion=e}groundLevel(e){this.groundHeight=e,this.rootMesh.position.y=this.rootMesh.position.y+e}jump(e){this.rootMesh.position.y=this.groundHeight+e}standUp(){this.jump(0),this.bendLeg(this.body.leftLeg,10),this.bendLeg(this.body.rightLeg,10)}rise(e){if(!(e<.001)){this.headPos().y+e>this.initialHeadPos.y&&(e=this.initialHeadPos.y-this.headPos().y);var t=(this.body.leftLeg.length+this.body.rightLeg.length)/2+e;this.bendLeg(this.body.leftLeg,t),this.bendLeg(this.body.rightLeg,t),this.rootMesh.position.y+=e}}crouch(e){if(!(e<.001)){var t=(this.body.leftLeg.length+this.body.rightLeg.length)/2;t-e<.1&&(e=t-.1);var i=t-e;this.bendLeg(this.body.leftLeg,i),this.bendLeg(this.body.rightLeg,i),this.rootMesh.position.y-=e}}bendLeg(e,t){if(t<0)console.log("ERROR: can't bend leg to "+t);else{var i=this.skeleton.bones[e.upper],s=this.skeleton.bones[e.lower];if(this.rootMesh.scaling.x,!(t>e.lowerLength+e.upperLength&&(t=e.lowerLength+e.upperLength)==e.length)){e.length=t,e.upperQuat||(e.upperQuat=BABYLON.Quaternion.FromRotationMatrix(i.getWorldMatrix().getRotationMatrix()),e.upperQuatInv=BABYLON.Quaternion.Inverse(e.upperQuat),e.lowerQuat=BABYLON.Quaternion.FromRotationMatrix(s.getWorldMatrix().getRotationMatrix()),e.lowerQuatInv=BABYLON.Quaternion.Inverse(e.lowerQuat),e.upperRot=i.getTransformNode().rotationQuaternion.clone());var o=(e.lowerLength+e.upperLength)/2,n=Math.asin(t/2/o),r=Math.PI/2-n,a=2*r,h=e.frontAxis.axis,l=e.frontAxis.sign,d=BABYLON.Quaternion.RotationAxis(h,r*l);i.getTransformNode().rotationQuaternion=e.upperRot.multiply(d);var c=e.upperQuat.multiply(e.lowerQuatInv),u=BABYLON.Quaternion.RotationAxis(h,-a*l);return u=u.multiply(c),s.getTransformNode().rotationQuaternion=u,t}}}calcLength(e){var t=this.skeleton.bones[e.upper],i=this.skeleton.bones[e.lower],s=this.rootMesh.scaling.x;e.upperLength=t.getAbsolutePosition().subtract(i.getAbsolutePosition()).length()*s,i.children&&i.children[0]?e.lowerLength=i.getAbsolutePosition().subtract(i.children[0].getAbsolutePosition()).length()*s:e.lowerLength=0,e.length=e.upperLength+e.lowerLength,this.log("Length of "+t.name+": "+e.upperLength+", "+i.name+": "+e.lowerLength)}sum(e){return e.x+e.y+e.z}rotateBoneTo(e,t,i){var s=BABYLON.Matrix.RotationAxis(t,i),o=BABYLON.Quaternion.FromRotationMatrix(s);e.setRotationQuaternion(o)}rotateBoneFor(e,t,i){var s=BABYLON.Matrix.RotationAxis(t,i),o=e.rotationQuaternion,n=BABYLON.Quaternion.FromRotationMatrix(s);e.setRotationQuaternion(o.multiply(n))}guessArmsRotations(){var e=this.skeleton.bones[this.body.leftArm.upper],t=this.skeleton.bones[this.body.leftArm.lower],i=this.skeleton.bones[this.body.rightArm.upper],s=this.skeleton.bones[this.body.rightArm.lower];this.body.leftArm.sideAxis=this.guessRotation(e,BABYLON.Axis.Y),this.body.rightArm.sideAxis=this.guessRotation(i,BABYLON.Axis.Y,this.body.leftArm.sideAxis.axis),this.body.leftArm.frontAxis=this.guessRotation(e,BABYLON.Axis.Z),this.body.rightArm.frontAxis=this.guessRotation(i,BABYLON.Axis.Z,this.body.leftArm.frontAxis.axis),this.log("Left arm axis, side: "+this.body.leftArm.sideAxis.sign+this.body.leftArm.sideAxis.axis),this.log("Left arm axis, front: "+this.body.leftArm.frontAxis.sign+this.body.leftArm.frontAxis.axis),this.log("Right arm axis, side: "+this.body.rightArm.sideAxis.sign+this.body.rightArm.sideAxis.axis),this.log("Right arm axis, front: "+this.body.rightArm.frontAxis.sign+this.body.rightArm.frontAxis.axis),this.body.leftArm.upperRot=BABYLON.Quaternion.FromRotationMatrix(e.getRotationMatrix()),this.body.leftArm.lowerRot=BABYLON.Quaternion.FromRotationMatrix(t.getRotationMatrix()),this.body.rightArm.upperRot=BABYLON.Quaternion.FromRotationMatrix(i.getRotationMatrix()),this.body.rightArm.lowerRot=BABYLON.Quaternion.FromRotationMatrix(s.getRotationMatrix())}guessLegsRotations(){var e=this.skeleton.bones[this.body.leftLeg.upper],t=this.skeleton.bones[this.body.leftLeg.lower],i=this.skeleton.bones[this.body.rightLeg.upper],s=this.skeleton.bones[this.body.rightLeg.lower];this.body.leftLeg.frontAxis=this.guessRotation(e,BABYLON.Axis.Z),this.body.rightLeg.frontAxis=this.guessRotation(i,BABYLON.Axis.Z,this.body.leftLeg.frontAxis.axis),this.body.leftLeg.upperRot=BABYLON.Quaternion.FromRotationMatrix(e.getRotationMatrix()),this.body.leftLeg.lowerRot=BABYLON.Quaternion.FromRotationMatrix(t.getRotationMatrix()),this.body.rightLeg.upperRot=BABYLON.Quaternion.FromRotationMatrix(i.getRotationMatrix()),this.body.rightLeg.lowerRot=BABYLON.Quaternion.FromRotationMatrix(s.getRotationMatrix())}guessRotation(e,t,i){var s=[BABYLON.Axis.X,BABYLON.Axis.Y,BABYLON.Axis.Z];i&&(s=[i]);for(var o,n,r=[Math.PI/2,-Math.PI/2],a=0,h=0;h<s.length;h++)for(var l=0;l<r.length;l++){var d=this.tryRotation(e,s[h],r[l]).multiply(t),c=d.x+d.y+d.z;c>a&&(o=s[h],n=r[l],a=c)}return{axis:o,sign:Math.sign(n)}}tryRotation(e,t,i){var s=e.children[0],o=e.getRotationQuaternion(),n=s.getAbsolutePosition(),r=BABYLON.Matrix.RotationAxis(t,i),a=e.rotationQuaternion,h=BABYLON.Quaternion.FromRotationMatrix(r);e.setRotationQuaternion(a.multiply(h)),e.computeAbsoluteTransforms();var l=s.getAbsolutePosition();return e.setRotationQuaternion(o),e.computeAbsoluteTransforms(),l.subtract(n)}euler(e){return e.rotationQuaternion.toEulerAngles()}degrees(e){var t=euler(e);return toDegrees(t)}toDegrees(e){var t=new BABYLON.Vector3;return t.x=180*e.x/Math.PI,t.y=180*e.y/Math.PI,t.z=180*e.z/Math.PI,t}countBones(e){if(e){this.bonesDepth++;for(var t=0;t<e.length;t++)this.bonesProcessed.includes(e[t].name)||(this.boneProcessed(e[t]),this.processBones(e[t].children))}}processBones(e){if(e){this.bonesDepth++;for(var t=0;t<e.length;t++)if(!this.bonesProcessed.includes(e[t].name)){this.boneProcessed(e[t]);var i=e[t].name.toLowerCase();!this.body.root&&i.includes("rootjoint")?(this.body.root=t,this.log("found root "+i+" at depth "+this.bonesDepth),this.processBones(e[t].children)):!this.body.hips&&this.isHipsName(i)&&e[t].children.length>=3?(this.body.hips=t,this.log("found hips "+i),this.processHips(e[t].children)):this.processBones(e[t].children)}this.bonesDepth--}}isHipsName(e){return e.includes("pelvis")||e.includes("hip")||e.includes("spine")||e.includes("root")}processHips(e){for(var t=0;t<e.length;t++){var i=e[t].name.toLowerCase();i.includes("spine")||i.includes("body")?this.processSpine(e[t]):i.includes("left")||this.isLegName(i,"l",e[t].children)?this.tryLeg(this.body.leftLeg,e[t]):i.includes("right")||this.isLegName(i,"r",e[t].children)?this.tryLeg(this.body.rightLeg,e[t]):e[t].children.length>=3&&this.isHipsName(i)?(this.log("Don't know how to handle bone "+i+", assuming hips"),this.boneProcessed(e[t]),this.processHips(e[t].children)):e[t].children.length>0?(this.log("Don't know how to handle bone "+i+", assuming spine"),this.processSpine(e[t])):(this.log("Don't know how to handle bone "+i),this.boneProcessed(e[t]))}}isLegName(e,t,i){return e.includes(t+"leg")||e.includes(t+"_")||e.includes(" "+t+" ")||e.includes(t+"thigh")||e.includes(t+"hip")||i.length>0&&i[0].children.length>0&&i[0].name.toLowerCase().includes(t+"_")}tryLeg(e,t){t.name.toLowerCase().includes("thigh")||t.name.toLowerCase().includes("leg")?this.processLeg(e,t):0==t.children.length||1==t.children.length&&0==t.children[0].children.length?(this.log("Ignoring bone "+t.name),this.boneProcessed(t)):1==t.children.length&&1==t.children[0].children.length&&0==t.children[0].children[0].children.length?e.upper&&e.lower?(this.log("Ignoring 1-joint leg "+t.name),this.boneProcessed(t)):(this.log("Processing 1-joint leg "+t.name),this.processLeg(e,t.children[0])):(this.log("Don't know how to handle leg "+t.name+", trying children"),this.boneProcessed(t),this.processLeg(e,t.children[0]))}processLeg(e,t){this.log("Processing leg "+t.name),e.upper&&e.lower&&this.log("WARNING: leg already exists"),this.boneProcessed(t),e.upper=this.skeleton.getBoneIndexByName(t.name),t=t.children[0],this.boneProcessed(t),e.lower=this.skeleton.getBoneIndexByName(t.name),t.children&&t.children[0]&&this.processFoot(e,t.children[0])}processFoot(e,t){this.boneProcessed(t),e.foot.push(this.skeleton.getBoneIndexByName(t.name)),t.children&&1==t.children.length&&this.processFoot(e,t.children[0])}processSpine(e){if(e)if(this.boneProcessed(e),1==e.children.length)this.body.spine.push(this.skeleton.getBoneIndexByName(e.name)),this.processSpine(e.children[0]);else if(e.children.length>=3&&this.hasHeadAndShoulders(e))for(var t=0;t<e.children.length;t++){var i=e.children[t].name.toLowerCase();i.includes("neck")||i.includes("head")||i.includes("collar")&&!i.includes("bone")&&!i.includes("lcollar")&&!i.includes("rcollar")?!i.includes("head")&&e.children[t].children.length>2?(this.log("Neck "+i+" of "+e.name+" has "+e.children[t].children.length+" children, assuming arms"),this.processNeck(e.children[t]),this.processSpine(e.children[t])):e.name.toLowerCase().includes("neck")&&i.toLowerCase().includes("head")?(this.log("Arms grow out from neck?!"),this.processNeck(e)):this.processNeck(e.children[t]):this.isArm(e.children[t],i)?i.includes("left")||this.isArmName(i,"l")?this.processArms(this.body.leftArm,e.children[t]):i.includes("right")||this.isArmName(i,"r")?this.processArms(this.body.rightArm,e.children[t]):(this.log("Don't know how to handle shoulder "+i),this.boneProcessed(e.children[t])):this.log("Don't know how to handle bone "+i)}else e.name.toLowerCase().includes("breast")?this.countBones(e.children):(this.log("Not sure how to handle spine "+e.name+", trying recursion"),this.body.spine.push(this.skeleton.getBoneIndexByName(e.name)),this.processSpine(e.children[0]))}isArmName(e,t){return e.includes(t+"shoulder")||e.includes(t+"clavicle")||e.includes(t+"collar")||e.includes(t+"arm")||e.includes(" "+t+" ")||e.includes(t+"_")}isArm(e,t){return!(!t.includes("shoulder")&&!t.includes("clavicle"))||this.hasChildren(e)&&this.hasChildren(e.children[0])&&this.hasChildren(e.children[0].children[0])}hasChildren(e){return e.children&&e.children.length>0}hasHeadAndShoulders(e){for(var t=0,i=0;i<e.children.length;i++)this.isHeadOrShoulder(e.children[i])&&t++;return this.log("Head and shoulders count: "+t+"/"+e.children.length),t>=3}isHeadOrShoulder(e){var t=e.name.toLowerCase();return t.includes("head")||t.includes("neck")||e.children&&e.children.length>0&&(t.includes("shoulder")||t.includes("clavicle")||t.includes("collar")||t.includes("arm"))}processNeck(e){if(this.body.neck.neck&&this.bonesProcessed.includes(e.name))this.log("neck "+e.name+" already processed: "+this.body.neck.neck);else{this.log("processing neck "+e.name+" children: "+e.children.length),this.body.neck=this.skeleton.getBoneIndexByName(e.name),this.boneProcessed(e);var t=e;e.children&&e.children.length>0?e=e.children[0]:this.log("Missing head?!"),this.body.head=this.skeleton.getBoneIndexByName(e.name);var i=e,s=new BABYLON.Vector3;i.getDirectionToRef(BABYLON.Axis.Z,this.rootMesh,s),this.roundVector(s),this.log("RefZ head: "+s);var o=new BABYLON.Vector3;t.getDirectionToRef(BABYLON.Axis.Z,this.rootMesh,o),this.roundVector(o),this.log("RefZ neck: "+o),this.headAxisFix=s.z*o.z,this.headQuat=BABYLON.Quaternion.FromRotationMatrix(i.getWorldMatrix().getRotationMatrix()),this.headQuatInv=BABYLON.Quaternion.Inverse(this.headQuat),this.neckQuat=BABYLON.Quaternion.FromRotationMatrix(t.getWorldMatrix().getRotationMatrix()),this.neckQuatInv=BABYLON.Quaternion.Inverse(this.neckQuat);var n=new BABYLON.Vector3(0,0,1);n.rotateByQuaternionToRef(BABYLON.Quaternion.Inverse(this.rootMesh.rotationQuaternion),n),n.rotateByQuaternionToRef(this.headQuatInv,n),this.headTarget=n.negate().normalizeToNew(),this.log("Head target: "+this.headTarget+" axisFix "+this.headAxisFix),this.boneProcessed(e),this.countBones(e.children)}}processArms(e,t){if(this.log("Processing arm "+t.name+" "+t.getIndex()+" "+this.skeleton.getBoneIndexByName(t.name)),e.shoulder=this.skeleton.getBoneIndexByName(t.name),this.boneProcessed(t),t=t.children[0],e.upper=this.skeleton.getBoneIndexByName(t.name),this.boneProcessed(t),t=t.children[0],e.lower=this.skeleton.getBoneIndexByName(t.name),this.boneProcessed(t),t=t.children[0],e.hand=this.skeleton.getBoneIndexByName(t.name),this.boneProcessed(t),t.children)if(5==t.children.length)for(var i=0;i<t.children.length;i++){var s=t.children[i].name.toLowerCase();s.includes("index")||s.includes("point")?this.processFinger(e.fingers.index,t.children[i]):s.includes("middle")?this.processFinger(e.fingers.middle,t.children[i]):s.includes("pink")||s.includes("little")?this.processFinger(e.fingers.pinky,t.children[i]):s.includes("ring")?this.processFinger(e.fingers.ring,t.children[i]):s.includes("thumb")?this.processFinger(e.fingers.thumb,t.children[i]):(this.log("Can't process finger "+s),this.boneProcessed(t.children[i]))}else this.log("Can't process fingers of "+t.name+" length: "+t.children.length)}processFinger(e,t){t&&(e.push(this.skeleton.getBoneIndexByName(t.name)),this.boneProcessed(t),t.children&&t.children.length>0&&this.processFinger(e,t.children[0]))}processAnimations(e){for(var t=[],i=0;i<e.length;i++){this.animationTargets.includes(e[i].target.name)||(this.animationTargets.push(e[i].target.name),this.bonesProcessed.includes(e[i].target.name)||this.log("Missing target "+e[i].target.name));for(var s=e[i].animation.getKeys(),o=0;o<s.length;o++)t.includes(s[o].frame)||t.push(s[o].frame)}}startAnimation(e){for(var t=0;t<this.getAnimationGroups().length;t++){var i=this.getAnimationGroups()[t];i.name==e?i.isPlaying?(i.pause(),this.log("paused "+e)):(this.fixes&&void 0!==this.fixes.beforeAnimation&&(this.log("Applying fixes for: "+this.folder.name+" beforeAnimation: "+this.fixes.beforeAnimation),this.groundLevel(this.fixes.beforeAnimation)),this.jump(0),i.play(i.loopAnimation),this.log("playing "+e),this.activeAnimation=e):i.isPlaying&&(i.pause(),i.reset())}}castShadows(e){if(this.character&&this.character.meshes)for(var t=0;t<this.character.meshes.length;t++)if(e)e.getShadowMap().renderList.push(this.character.meshes[t]);else if(this.shadowGenerator){var i=this.shadowGenerator.getShadowMap().renderList.indexOf(this.character.meshes[t]);i>=0&&this.shadowGenerator.getShadowMap().renderList.splice(i,1)}this.shadowGenerator=e}resize(){var e=this.rootMesh.scaling.y;return e=e*this.userHeight/this.headPos().y,this.rootMesh.scaling=new BABYLON.Vector3(e,e,e),this.initialHeadPos=this.headPos(),this.log("Rescaling to "+e+", head position "+this.initialHeadPos),e}}class m{constructor(){this.scripts=[]}add(e){return this.scripts.includes(e)||this.scripts.push(e),this}async load(e=!1){for(var t=0;t<this.scripts.length;t++)await this.loadScript(this.scripts[t],e)}async loadScript(e,t){return new Promise(((i,s)=>{const o=document.createElement("script");o.src=e,t?(document.body.appendChild(o),i()):(o.async=!0,document.body.appendChild(o),o.onload=()=>{i()})}))}}class p{constructor(){this.scene=null,this.logo=null,this.portal=null,this.debug=!1,this.fps=5,this.contentBase="",this.loadProgressIndicator=(e,t)=>this.loadProgressIndicatorFactory(e,t),this.scriptLoader=new m,this.indicator=null,this.initialized=!1,this.optimizingScene=!1,this.VRSPACE=u}async init(e){if(!this.initialized||this.scene!==e){this.scene=e;var t=await BABYLON.SceneLoader.LoadAssetContainerAsync(this.contentBase+"/babylon/","logo.glb",this.scene);this.logo=t.meshes[0];for(var i=0;i<t.meshes;i++)t.meshes[i].checkCollisions=!1;this.logo.name="VRSpace.org Logo",await this.loadPortal(e),this.initialized=!0}return this}loadProgressIndicatorFactory(e,t){return this.indicator||(this.indicator=new v(e,t)),this.indicator}log(e){this.debug&&console.log(e)}async loadPortal(e){if(!this.portal){var t=await BABYLON.SceneLoader.LoadAssetContainerAsync(this.contentBase+"/babylon/portal/","scene.gltf",e);t.materials[0].albedoColor=BABYLON.Color3.FromHexString("#B3EEF3"),t.materials[0].metallic=.85,this.portal=t.createRootMesh(),this.portal.rotation=new BABYLON.Vector3(0,Math.PI/2,0),this.portal.name="Portal"}return this.portal}listFiles(e,t){this.log("Fetching "+e);var i=new XMLHttpRequest;return i.responseType="document",i.onreadystatechange=function(){4==i.readyState&&200==i.status&&t(i)},i.open("GET",e,!0),i.send(null),i}listThumbnails(e,t){this.listMatchingFiles(e,t,".jpg")}listCharacters(e,t){this.listMatchingFiles(e,t,"-fixes.json")}listMatchingFiles(e,t,i){e.endsWith("/")||(e+="/");var s=this;return this.listFiles(e,(o=>{for(var n=o.responseXML.links,r=[],a=[],h=0;h<n.length;h++){var l=n[h],d=l.href;d.indexOf("?")>0||l.baseURI.length>l.href.length||(l.href.endsWith(i)?a.push(d.substring(l.baseURI.length)):l.href.endsWith("/")&&(d=(d=d.substring(l.baseURI.length)).substring(0,d.indexOf("/")),s.log(l.baseURI+" "+d),r.push(d)))}var c=[];for(h=0;h<r.length;h++){var u=null,g=r[h]+i,m=a.indexOf(g);m>=0&&(u=a[m]),c.push(new f(e,r[h],u))}s.log(c),t(c)}))}receiveShadows(e,t){e.receiveShadows=t,e.material&&"PBRMaterial"==e.material.getClassName()&&(e.material.usePhysicalLightFalloff=!1);for(var i=e.getChildren(),s=0;s<i.length;s++)this.receiveShadows(i[s],t)}copyMesh(e,t,i){if(e.geometry)(s=e.createInstance(e.name+"-copy")).parent=t;else if(i&&t)s=t;else{var s;(s=e.clone(e.name+"-copy",t,!0,!1)).parent=t}for(var o=e.getChildren(),n=0;n<o.length;n++)this.copyMesh(o[n],s,i);return s}createAnimation(e,t,i){i||(i=this.fps);var s=new BABYLON.AnimationGroup(t+" "+e.id),o=new BABYLON.Animation("xAnim "+e.id,t+".x",i,BABYLON.Animation.ANIMATIONTYPE_FLOAT,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),n=[];n.push({frame:0,value:0}),n.push({frame:1,value:0}),o.setKeys(n);var r=new BABYLON.Animation("yAnim "+e.id,t+".y",i,BABYLON.Animation.ANIMATIONTYPE_FLOAT,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),a=[];a.push({frame:0,value:0}),a.push({frame:1,value:0}),r.setKeys(a);var h=new BABYLON.Animation("zAnim "+e.id,t+".z",i,BABYLON.Animation.ANIMATIONTYPE_FLOAT,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),l=[];return l.push({frame:0,value:0}),l.push({frame:1,value:0}),h.setKeys(l),s.addTargetedAnimation(o,e),s.addTargetedAnimation(r,e),s.addTargetedAnimation(h,e),s}updateAnimation(e,t,i){e.isPlaying&&e.stop();var s=e.targetedAnimations[0].animation;s.getKeys()[0].value=t.x,s.getKeys()[1].value=i.x;var o=e.targetedAnimations[1].animation;o.getKeys()[0].value=t.y,o.getKeys()[1].value=i.y;var n=e.targetedAnimations[2].animation;n.getKeys()[0].value=t.z,n.getKeys()[1].value=i.z,e.play(!1)}createQuaternionAnimation(e,t,i){i||(i=this.fps);var s=new BABYLON.AnimationGroup(t+" "+e.id),o=new BABYLON.Animation("qAnim "+e.id,t,i,BABYLON.Animation.ANIMATIONTYPE_QUATERNION,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),n=[];return n.push({frame:0,value:0}),n.push({frame:1,value:0}),o.setKeys(n),s.addTargetedAnimation(o,e),s}updateQuaternionAnimation(e,t,i){e.isPlaying&&e.stop();var s=new BABYLON.Quaternion.FromEulerAngles(0,i.y,0),o=e.targetedAnimations[0].animation;o.getKeys()[0].value=t,o.getKeys()[1].value=s,e.play(!1)}optimizeScene(e){this.optimizingScene||(this.optimizingScene=!0,console.log("Running scene optimizer..."),BABYLON.SceneOptimizer.OptimizeAsync(e,BABYLON.SceneOptimizerOptions.HighDegradationAllowed(),(()=>{this.optimizingScene=!1,console.log("Scene optimized")}),(()=>{this.optimizingScene=!1,console.log("Scene optimization unsuccessfull")})))}async loadScriptsToDocument(e,t){return Array.isArray(e)?e.forEach((e=>this.scriptLoader.add(e))):this.scriptLoader.add(e),this.scriptLoader.load(t)}findRootNode(e){for(var t=e;t&&t.parent;)t=t.parent;return t}}let B;void 0===window.VRSPACEUI?(B=new p,window.VRSPACEUI=B):B=window.VRSPACEUI;class A{constructor(e){this.scene=e,this.diameter=20,this.shadows=!0}async load(){this.floorGroup=new BABYLON.TransformNode("Floor"),this.ground=BABYLON.MeshBuilder.CreateDisc("ground",{},this.scene),this.ground.rotation=new BABYLON.Vector3(Math.PI/2,0,0),this.ground.position=new BABYLON.Vector3(0,.1,0),this.ground.parent=this.floorGroup,this.ground.isVisible=!1,this.ground.checkCollisions=!0,await B.init(this.scene),B.receiveShadows(B.logo,this.shadows),B.copyMesh(B.logo,this.floorGroup,!0);var e=BABYLON.MeshBuilder.CreateCylinder("FloorWalls",{height:4,diameter:1,sideOrientation:BABYLON.Mesh.BACKSIDE},this.scene);return e.checkCollisions=!0,e.isVisible=!1,e.position=new BABYLON.Vector3(0,2,0),e.parent=this.floorGroup,this.setDiameter(this.diameter),this.floorGroup.position=new BABYLON.Vector3(0,-.05,0),this.scene.addTransformNode(this.floorGroup),this}dispose(){this.floorGroup.dispose()}setDiameter(e){this.diameter=e,this.floorGroup.scaling=new BABYLON.Vector3(this.diameter,2,this.diameter)}getDiameter(){return this.diameter}}class b{constructor(e,t,i,s){this.scene=e,this.serverFolder=t,this.callback=i,this.name=t.name,t.relatedUrl()&&(this.thumbnail=new BABYLON.Texture(t.relatedUrl())),this.shadowGenerator=s,this.isEnabled=!1,this.controls=[],this.textures=[],this.materials=[]}worldUrl(){return this.serverFolder.baseUrl+this.serverFolder.name}dispose(){this.group.dispose(),this.thumbnail&&this.thumbnail.dispose(),this.material.dispose();for(var e=0;e<this.controls.length;e++)this.controls[e].dispose();for(e=0;e<this.textures.length;e++)this.textures[e].dispose();for(e=0;e<this.materials.length;e++)this.materials[e].dispose()}async loadAt(e,t,i,s){if(this.group=new BABYLON.TransformNode("Portal:"+this.name),this.group.position=new BABYLON.Vector3(e,t,i),this.group.rotationQuaternion=new BABYLON.Quaternion.RotationAxis(BABYLON.Axis.Y,s),this.shadowGenerator){var o=B.portal.clone();o.parent=this.group;for(var n=o.getChildMeshes(),r=0;r<n.length;r++)this.shadowGenerator.getShadowMap().renderList.push(n[r])}else B.copyMesh(B.portal,this.group);var a=BABYLON.Mesh.CreatePlane("PortalEntrance:"+this.name,1.6,this.scene);a.parent=this.group,a.position=new BABYLON.Vector3(0,1.32,0),this.scene.onPointerObservable.add((e=>{e.type==BABYLON.PointerEventTypes.POINTERDOWN&&e.pickInfo.pickedMesh==a&&(this.isEnabled?(console.log("Entering "+this.name),this.scene.onPointerObservable.clear(),this.enter()):console.log("Not entering "+this.name+" - disabled"))})),this.material=new BABYLON.StandardMaterial(this.name+"-noise",this.scene),a.material=this.material,this.material.disableLighting=!0,this.material.backFaceCulling=!1;var h=new BABYLON.NoiseProceduralTexture(this.name+"-perlin",256,this.scene);this.material.lightmapTexture=h,h.octaves=4,h.persistence=1.2,h.animationSpeedFactor=2,a.visibility=.85,this.textures.push(h),this.title=BABYLON.MeshBuilder.CreatePlane("Text:"+this.name,{height:1,width:2},this.scene),this.title.parent=this.group,this.title.position=new BABYLON.Vector3(0,2.5,0),this.title.isVisible=!1;var l=BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(this.title,128,128);this.materials.push(this.title.material);var d=new BABYLON.GUI.TextBlock;return d.text=this.name,d.color="white",l.addControl(d),this.textures.push(l),this}enabled(e){this.material.emissiveTexture=e?this.thumbnail:null,this.title.isVisible=e,this.isEnabled=e}enter(){this.callback&&this.callback(this)}}class f{constructor(e,t,i){this.baseUrl=e,this.name=t,this.related=i}url(){return this.baseUrl+this.name}relatedUrl(){return this.related?this.baseUrl+this.related:null}}class v{constructor(e,t){this.scene=e,this.camera=t,this.mesh=null,this.totalItems=0,this.currentItem=0,this.zeroRotation=null,this.angle=0,this.debug=!1,this.trackItems=!0;var i=this;B.init(e).then((e=>{i.mesh=e.logo.clone("LoadingProgressIndicator"),i.mesh.scaling.scaleInPlace(.05),i.attachTo(i.camera),i.zeroRotation=new BABYLON.Quaternion.RotationAxis(BABYLON.Axis.X,Math.PI/2),i.mesh.rotationQuaternion=i.zeroRotation,i.mesh.setEnabled(i.totalItems>i.currentItem),i.log("Loaded logo, current progress "+i.currentItem+"/"+i.totalItems)})),this.scene.onActiveCameraChanged.add((()=>{this.scene.activeCamera&&(console.log("Camera changed: "+this.scene.activeCamera.getClassName()),this.attachTo(t))}))}_init(){this.totalItems=0,this.currentItem=0,this.angle=0}attachTo(e){this.camera=this.scene.activeCamera,this.mesh&&(this.mesh.parent=this.scene.activeCamera,"WebXRCamera"==this.scene.activeCamera.getClassName()?this.mesh.position=new BABYLON.Vector3(0,-.2,.5):this.mesh.position=new BABYLON.Vector3(0,-.1,.5))}add(e){this.mesh&&!this.mesh.isEnabled()&&this.mesh.setEnabled(!0),this.totalItems++,this.log("Added "+this.currentItem+"/"+this.totalItems),this._update()}remove(e){this.currentItem++,this._update(),this.log("Finished "+this.currentItem+"/"+this.totalItems),this.totalItems<=this.currentItem&&this.mesh&&(this.mesh.setEnabled(!1),this.animation&&(this.scene.unregisterBeforeRender(this.animation),delete this.animation),this._init())}animate(){this.trackItems=!1,this.animation=()=>{this._update()},this.scene.registerBeforeRender(this.animation)}progress(e,t){if(this.trackItems=!1,e.lengthComputable){var i=e.loaded/e.total;this.log("Loaded "+100*i+"%"),this.mesh&&this.zeroRotation&&(this.angle-=.01,this.mesh.rotationQuaternion=this.zeroRotation.multiply(new BABYLON.Quaternion.RotationAxis(BABYLON.Axis.Y,this.angle)))}else{var s=e.loaded/1048576;this.log("Loaded "+s+" MB")}}_update(){this.mesh&&this.zeroRotation&&(this.trackItems?this.angle=2*Math.PI*(1-this.currentItem/this.totalItems):this.angle-=.01,this.mesh.rotationQuaternion=this.zeroRotation.multiply(new BABYLON.Quaternion.RotationAxis(BABYLON.Axis.Y,this.angle)))}log(e){this.debug&&console.log(e)}}class y{constructor(e){this.scene=e,this.recorder=null,e.onActiveCameraChanged.add((e=>this.cameraChanged()))}cameraChanged(){console.log("Camera changed: "+this.scene.activeCamera.getClassName()+" new position "+this.scene.activeCamera.position),this.camera=this.scene.activeCamera,this.recordButton.mesh.parent=this.camera,this.stopButton.mesh.parent=this.camera,this.playButton.mesh.parent=this.camera}showUI(){this.camera=this.scene.activeCamera;var e=new BABYLON.GUI.GUI3DManager(this.scene);this.recordButton=new BABYLON.GUI.HolographicButton("RecordEvents"),e.addControl(this.recordButton),this.recordButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Dot.png",this.recordButton.text="REC",this.recordButton.position=new BABYLON.Vector3(-.1,-.1,.5),this.recordButton.scaling=new BABYLON.Vector3(.05,.05,.05),this.recordButton.onPointerDownObservable.add((()=>this.record())),this.recordButton.mesh.parent=this.camera,this.stopButton=new BABYLON.GUI.HolographicButton("StopRecording"),this.stopButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Pause.png",this.stopButton.text="Stop",e.addControl(this.stopButton),this.stopButton.position=new BABYLON.Vector3(0,-.1,.5),this.stopButton.scaling=new BABYLON.Vector3(.05,.05,.05),this.stopButton.onPointerDownObservable.add((()=>this.stop())),this.stopButton.mesh.parent=this.camera,this.stopButton.isVisible=!1,this.playButton=new BABYLON.GUI.HolographicButton("StartPlaying"),this.playButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Play.png",e.addControl(this.playButton),this.playButton.text="Play",this.playButton.position=new BABYLON.Vector3(.1,-.1,.5),this.playButton.scaling=new BABYLON.Vector3(.05,.05,.05),this.playButton.onPointerDownObservable.add((()=>this.play())),this.playButton.mesh.parent=this.camera,this.playButton.isVisible=!1}record(){console.log("Recording..."),this.recorder||u.send('{"command":{"Recording":{"action":"record"}}}'),this.stopButton.isVisible=!0,this.playButton.isVisible=!1}stop(){console.log("Stopped"),u.send('{"command":{"Recording":{"action":"stop"}}}'),this.recordButton.isVisible=!0,this.playButton.isVisible=!0,this.stopButton.isVisible=!1}play(){console.log("Playing..."),u.send('{"command":{"Recording":{"action":"play"}}}'),this.recordButton.isVisible=!1,this.stopButton.isVisible=!0}}class w{constructor(e,t){this.scene=e,this.size=t||1,this.decimals=2,this.floorMaterial=new BABYLON.StandardMaterial("floorMaterial",this.scene),this.floorMaterial.diffuseColor=new BABYLON.Color3(.5,1,.5),this.floorMaterial.backFaceCulling=!1,this.floorMaterial.alpha=.5,this.leftPath=[],this.rightPath=[],this.pathArray=[this.leftPath,this.rightPath],this.left=BABYLON.MeshBuilder.CreateSphere("leftSphere",{diameter:1},e),this.right=BABYLON.MeshBuilder.CreateSphere("rightSphere",{diameter:1},e),this.left.isVisible=!1,this.right.isVisible=!1,e.onActiveCameraChanged.add((e=>this.cameraChanged())),this.recording=!1,this.editing=!1,this.resizing=!1,this.floorCount=0}cameraChanged(){console.log("Camera changed: "+this.scene.activeCamera.getClassName()+" new position "+this.scene.activeCamera.position),this.camera=this.scene.activeCamera,this.left.parent=this.camera,this.right.parent=this.camera,this.recordButton.mesh.parent=this.camera,this.editButton.mesh.parent=this.camera,this.jsonButton.mesh.parent=this.camera,this.jsButton.mesh.parent=this.camera}showUI(){this.camera=this.scene.activeCamera;var e=new BABYLON.GUI.GUI3DManager(this.scene);this.recordButton=new BABYLON.GUI.HolographicButton("RecordPath"),e.addControl(this.recordButton),this.recordButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Play.png",this.recordButton.position=new BABYLON.Vector3(-.1,-.1,.5),this.recordButton.scaling=new BABYLON.Vector3(.05,.05,.05),this.recordButton.onPointerDownObservable.add((()=>this.startStopCancel())),this.editButton=new BABYLON.GUI.HolographicButton("EditPath"),this.editButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Edit.png",e.addControl(this.editButton),this.editButton.position=new BABYLON.Vector3(0,-.1,.5),this.editButton.scaling=new BABYLON.Vector3(.05,.05,.05),this.editButton.onPointerDownObservable.add((()=>this.edit())),this.jsonButton=new BABYLON.GUI.HolographicButton("SavePathJson"),this.jsonButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Download.png",e.addControl(this.jsonButton),this.jsonButton.text="JSON",this.jsonButton.position=new BABYLON.Vector3(.1,-.1,.5),this.jsonButton.scaling=new BABYLON.Vector3(.05,.05,.05),this.jsonButton.onPointerDownObservable.add((()=>this.saveJson())),this.jsButton=new BABYLON.GUI.HolographicButton("SavePathJs"),this.jsButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Download.png",e.addControl(this.jsButton),this.jsButton.text="JS",this.jsButton.position=new BABYLON.Vector3(.2,-.1,.5),this.jsButton.scaling=new BABYLON.Vector3(.05,.05,.05),this.jsButton.onPointerDownObservable.add((()=>this.saveJs())),this.editButton.isVisible=!1,this.jsonButton.isVisible=!1,this.jsButton.isVisible=!1,this.recordButton.mesh.parent=this.camera,this.editButton.mesh.parent=this.camera,this.jsonButton.mesh.parent=this.camera,this.jsButton.mesh.parent=this.camera}startStopCancel(){this.floorMesh?(this.floorMesh.dispose(),delete this.floorMesh,this.leftPath=[],this.rightPath=[],this.pathArray=[this.leftPath,this.rightPath]):(this.recording=!this.recording,this.recording?this.startRecording():this.createPath()),this.updateUI()}updateUI(){this.recording?this.recordButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Pause.png":this.floorMesh?this.recordButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Undo.png":this.recordButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Play.png",this.editButton.isVisible=!this.recording&&this.floorMesh,this.jsonButton.isVisible=!this.recording&&this.floorMesh,this.jsButton.isVisible=!this.recording&&this.floorMesh}trackActiveCamera(){var e=this.scene.activeCamera;e&&this.trackCamera(e)}startRecording(){this.leftPath=[],this.rightPath=[],this.pathArray=[this.leftPath,this.rightPath],this.trackActiveCamera()}trackCamera(e){console.log("Tracking camera"),e&&(this.camera=e),this.lastX=this.camera.position.x,this.lastZ=this.camera.position.z,this.observer=this.camera.onViewMatrixChangedObservable.add((e=>this.viewChanged(e))),this.left.parent=e,this.right.parent=e;var t=2*e.ellipsoid.y;"WebXRCamera"==this.camera.getClassName()&&(t=this.camera.realWorldHeight),this.left.position=new BABYLON.Vector3(-1,-t,0),this.right.position=new BABYLON.Vector3(1,-t,0)}viewChanged(e){(e.position.x>this.lastX+this.size||e.position.x<this.lastX-this.size||e.position.z>this.lastZ+this.size||e.position.z<this.lastZ-this.size)&&(this.lastX=e.position.x,this.lastZ=e.position.z,this.recording&&(this.leftPath.push(this.left.absolutePosition.clone()),this.rightPath.push(this.right.absolutePosition.clone())))}createPath(){this.leftPath.length>1&&this.addToScene(),this.camera.onViewMatrixChangedObservable.remove(this.observer),delete this.observer}addToScene(){this.floorCount++;var e=BABYLON.MeshBuilder.CreateRibbon("FloorRibbon"+this.floorCount,{pathArray:this.pathArray,updatable:!0},this.scene);e.material=this.floorMaterial,e.checkCollisions=!1,this.floorMesh=e}clear(){delete this.floorMesh,this.leftPath=[],this.rightPath=[],this.pathArray=[this.leftPath,this.rightPath],this.updateUI()}edit(){this.floorMesh&&(this.recordButton.isVisible=this.editing,this.jsonButton.isVisible=this.editing,this.jsButton.isVisible=this.editing,this.editing=!this.editing,this.resizing?(this.scene.onPointerObservable.remove(this.observer),this.resizing=!1,delete this.observer,delete this.pathPoints,delete this.point1,delete this.point2,this.editButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Edit.png",this.edgeMesh&&(this.edgeMesh.dispose(),delete this.edgeMesh)):this.editing?(this.editButton.imageUrl="//www.babylonjs-playground.com/textures/icons/Back.png",this.editButton.text="Pick 1",this.resizing=!0,this.observer=this.scene.onPointerObservable.add((e=>{switch(e.type){case BABYLON.PointerEventTypes.POINTERDOWN:e.pickInfo.hit&&e.pickInfo.pickedMesh==this.floorMesh&&(this.point1?this.point2?(this.pickedPoint=this.pickClosest(e.pickInfo),this.editButton.imageUrl="/content/icons/tick.png",this.editButton.text=null):(this.point2=this.pickClosest(e.pickInfo),this.selectEdge(),this.editButton.text="Drag"):(this.point1=this.pickClosest(e.pickInfo),this.editButton.text="Pick 2"));break;case BABYLON.PointerEventTypes.POINTERUP:delete this.pickedPoint;break;case BABYLON.PointerEventTypes.POINTERMOVE:this.pickedPoint&&e.pickInfo.pickedMesh==this.floorMesh&&this.resizeRibbon(e.pickInfo.pickedPoint)}}))):this.observer&&(this.editButton.text=null,this.scene.onPointerObservable.remove(this.observer)))}pickClosest(e){for(var t,i,s=0,o=!1,n=1e5,r=0;r<this.leftPath.length;r++){var a=e.pickedPoint.subtract(this.leftPath[r]).length(),h=e.pickedPoint.subtract(this.rightPath[r]).length();a<n&&(n=a,o=!0,s=r,t=this.leftPath,i=this.leftPath[r]),h<n&&(n=h,o=!1,s=r,t=this.rightPath,i=this.rightPath[r])}var l={index:s,path:t,left:o,pathPoint:i,point:e.pickedPoint.clone()};return console.log("Picked left: "+o+" index: "+s+"/"+t.length+" distance: "+n),l}selectEdge(){if(this.point1.index>this.point2.index){var e=this.point2;this.point2=this.point1,this.point1=e}for(var t=[],i=this.point1.index;i<=this.point2.index;i++)this.point1.left?t.push(this.leftPath[i]):t.push(this.rightPath[i]);this.pathPoints=t,this.pathPoints.length>1?this.edgeMesh=BABYLON.MeshBuilder.CreateLines("FloorEdge",{points:t,updatable:!0},this.scene):(this.edgeMesh=BABYLON.MeshBuilder.CreateSphere("FloorEdge",{diameter:.1},this.scene),this.edgeMesh.position=this.pathPoints[0])}resizeRibbon(e){for(var t=e.subtract(this.pickedPoint.point),i=0;i<this.pathPoints.length;i++)this.pathPoints[i].addInPlace(t);this.pickedPoint.point=e.clone();var s=BABYLON.MeshBuilder.CreateRibbon("FloorRibbon"+this.floorCount,{pathArray:this.pathArray,updatable:!0},this.scene);s.material=this.floorMaterial,s.checkCollisions=!1,this.floorMesh.dispose(),this.floorMesh=s,this.pathPoints.length>1&&BABYLON.MeshBuilder.CreateLines("FloorEdge",{points:this.pathPoints,instance:this.edgeMesh})}saveJson(){var e=this.printJson();this.saveFile("FloorRibbon"+this.floorCount+".json",e),this.clear()}saveJs(){var e=this.printJs();this.saveFile("FloorRibbon"+this.floorCount+".js",e),this.clear()}printJson(){var e='{"pathArray":\n';return e+="[\n",e+=this.printPathJson(this.leftPath),e+="\n],[\n",e+=this.printPathJson(this.rightPath),e+="\n]}",console.log(e),e}printJs(){var e="BABYLON.MeshBuilder.CreateRibbon( 'FloorRibbon"+this.floorCount+"', {pathArray: \n";return e+="[[\n",e+=this.printPathJs(this.leftPath),e+="\n],[\n",e+=this.printPathJs(this.rightPath),e+="\n]]}, scene );",console.log(e),e}printPathJs(e){for(var t="",i=0;i<e.length-1;i++)t+="new BABYLON.Vector3("+e[i].x.toFixed(this.decimals)+","+e[i].y.toFixed(this.decimals)+","+e[i].z.toFixed(this.decimals)+"),";return t+"new BABYLON.Vector3("+e[e.length-1].x.toFixed(this.decimals)+","+e[e.length-1].y.toFixed(this.decimals)+","+e[e.length-1].z.toFixed(this.decimals)+")"}printPathJson(e){for(var t="",i=0;i<e.length-1;i++)t+="["+e[i].x.toFixed(this.decimals)+","+e[i].y.toFixed(this.decimals)+","+e[i].z.toFixed(this.decimals)+"],";return t+"["+e[e.length-1].x.toFixed(this.decimals)+","+e[e.length-1].y.toFixed(this.decimals)+","+e[e.length-1].z.toFixed(this.decimals)+"]"}saveFile(e,t){var i=document.createElement("a"),s=new Blob([t],{type:"application/octet-stream"});i.href=window.URL.createObjectURL(s),i.download=e,i.click()}}class L{constructor(e,t,i,s,o){this.scene=e,this.title=t,this.options=i,this.callback=s,this.property=o,this.buttonHeight=1,this.color="white",this.addBackground=!1,this.group=new BABYLON.TransformNode("ButtonGroup:"+this.title,e),this.groupWidth=0,this.buttons=[],this.selectedOption=-1,this.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,this.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this.turOff=!1,this.controls=[],this.textures=[],this.materials=[],this.display()}dispose(){delete this.selectedMaterial,delete this.unselectedMaterial,this.group.dispose();for(var e=0;e<this.controls.length;e++)this.controls[e].dispose();for(e=0;e<this.textures.length;e++)this.textures[e].dispose();for(e=0;e<this.materials.length;e++)this.materials[e].dispose();console.log("Disposed of buttons "+this.title)}setHeight(e){var t=e/this.options.length;this.group.scaling=new BABYLON.Vector3(t,t,t)}display(){if(this.selectedMaterial=new BABYLON.StandardMaterial("selectedButtonMaterial",this.scene),this.selectedMaterial.diffuseColor=new BABYLON.Color3(0,0,0),this.selectedMaterial.emissiveColor=new BABYLON.Color3(.4,.8,.4),this.selectedMaterial.disableLighting=!0,this.materials.push(this.selectedMaterial),this.unselectedMaterial=new BABYLON.StandardMaterial("unselectedButtonMaterial",this.scene),this.unselectedMaterial.diffuseColor=new BABYLON.Color3(0,0,0),this.unselectedMaterial.emissiveColor=new BABYLON.Color3(.2,.2,.2),this.unselectedMaterial.disableLighting=!0,this.materials.push(this.unselectedMaterial),this.title&&this.title.length>0){var e=new BABYLON.GUI.TextBlock;e.text=this.title,e.textHorizontalAlignment=this.horizontalAlignment,e.textVerticalAlignment=this.verticalAlignment,e.color=this.color;var t=BABYLON.MeshBuilder.CreatePlane("Text"+this.title,{height:2,width:2*this.title.length},this.scene);t.parent=this.group,t.position=new BABYLON.Vector3(this.title.length,2.2,0);var i=BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(t,e.fontSizeInPixels*e.text.length,e.fontSizeInPixels,!1);i.addControl(e),this.controls.push(e),this.textures.push(i),this.materials.push(t.material)}for(var s=0;s<this.options.length;s++){if(this.property)var o=this.options[s][this.property];else o=this.options[s];this.groupWidth=Math.max(this.groupWidth,o.length);var n=new BABYLON.GUI.TextBlock;n.text=o,n.textHorizontalAlignment=this.horizontalAlignment,n.textVerticalAlignment=this.verticalAlignment;var r=n.text.length,a=BABYLON.MeshBuilder.CreatePlane("Text"+o,{height:1,width:r},this.scene);a.position=new BABYLON.Vector3(r/2+1,1.1*-s,0),n.color=this.color,a.parent=this.group;var h=BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(a,n.fontSizeInPixels*n.text.length,n.fontSizeInPixels+2,!1);h.addControl(n),this.controls.push(n),this.textures.push(h),a.material.alphaMode=5,this.materials.push(a.material);var l=BABYLON.MeshBuilder.CreateCylinder("Button"+o,{height:.1,diameter:.8},this.scene);l.material=this.unselectedMaterial,l.rotation=new BABYLON.Vector3(Math.PI/2,0,0),l.position=new BABYLON.Vector3(.5,1.1*-s,0),l.parent=this.group,this.buttons.push(l)}if(this.scene.onPointerObservable.add((e=>{if(e.type==BABYLON.PointerEventTypes.POINTERDOWN)for(var t=e.pickInfo,i=0;i<this.options.length;i++)if(t.pickedMesh==this.buttons[i]){(i!=this.selectedOption||this.turnOff)&&this.select(i);break}})),this.addBackground){console.log("Group width: "+this.groupWidth);var d=this.groupWidth/1.8,c=1.1*this.options.length,u=BABYLON.MeshBuilder.CreatePlane("ButtonBackground:"+this.title,{height:c,width:d},this.scene);u.position=new BABYLON.Vector3(d/2+.8,-c/2+.55,.2),u.parent=this.group;var g=new BABYLON.StandardMaterial("unselectedButtonMaterial",this.scene);g.disableLighting=!0,this.materials.push(g),u.material=g}}select(e){console.log("Selected: "+this.options[e].name),this.callback&&this.callback(this.options[e]),this.buttons[e].material=this.selectedMaterial,this.selectedOption>-1&&(this.buttons[this.selectedOption].material=this.unselectedMaterial),e!=this.selectedOption?this.selectedOption=e:this.selectedOption=-1}hide(){this.group.isEnabled=!1}show(){this.group.isEnabled=!0}}class x{async initXR(e){this.world=e;var t=this.vrHelper;if(this.vrHelper)console.log("VR helper already intialized"),this.addFloors();else try{t=await this.world.scene.createDefaultXRExperienceAsync({floorMeshes:this.world.getFloorMeshes()})}catch(e){console.log("Can't init XR:"+e)}t&&t.baseExperience?(console.log("Using XR helper"),this.vrHelper=t,this.movementObserver&&t.baseExperience.sessionManager.onXRReferenceSpaceChanged.remove(this.movementObserver),this.movementObserver=()=>{this.afterTeleportation()},t.baseExperience.sessionManager.onXRReferenceSpaceChanged.add(this.movementObserver),this.initialPoseObserver||(this.initialPoseObserver=e=>{e.position.y=this.world.camera.position.y-2*this.world.camera.ellipsoid.y},t.baseExperience.onInitialXRPoseSetObservable.add(this.initialPoseObserver)),this.tracker&&this.stopTracking(),this.tracker=()=>this.world.trackXrDevices(),this.stateChangeObserver||(this.stateChangeObserver=e=>{switch(console.log("State: "+e),e){case BABYLON.WebXRState.IN_XR:console.log("Entered VR"),this.startTracking(),t.teleportation.setSelectionFeature(null),this.world.inXR=!0;break;case BABYLON.WebXRState.ENTERING_XR:console.log("Entering VR"),this.world.collisions(!1);break;case BABYLON.WebXRState.EXITING_XR:console.log("Exiting VR"),this.stopTracking(),this.world.camera.position=this.camera().position.clone(),this.world.camera.rotation=this.camera().rotation.clone(),this.world.collisions(this.world.collisionsEnabled),this.world.inXR=!1;break;case BABYLON.WebXRState.NOT_IN_XR:console.log("Not in VR"),this.world.attachControl(),this.world.scene.activeCamera=this.world.camera}},t.baseExperience.onStateChangedObservable.add(this.stateChangeObserver)),this.world.scene.pointerMovePredicate=e=>this.world.isSelectableMesh(e),t.pointerSelection.raySelectionPredicate=e=>this.world.isSelectableMesh(e),t.teleportation.rotationEnabled=!1,this.controllerObserver||(this.controllerObserver=e=>{console.log("Controller added: "+e.grip.name+" "+e.grip.name),console.log(e),e.grip.id.toLowerCase().indexOf("left")>=0||e.grip.name.toLowerCase().indexOf("left")>=0?this.leftController=e:e.grip.id.toLowerCase().indexOf("right")>=0||e.grip.name.toLowerCase().indexOf("right")>=0?this.rightController=e:log("ERROR: don't know how to handle controller")},t.input.onControllerAddedObservable.add(this.controllerObserver))):(this.vrHelper=this.world.scene.createDefaultVRExperience({createDeviceOrientationCamera:!1}),this.vrHelper.webVRCamera.ellipsoid=new BABYLON.Vector3(.5,1.8,.5),this.vrHelper.onEnteringVRObservable.add((()=>{this.world.collisions(!1)})),this.vrHelper.onExitingVRObservable.add((()=>{this.world.collisions(this.world.collisionsEnabled)})),this.vrHelper.enableTeleportation({floorMeshes:this.world.getFloorMeshes(this.world.scene)}),this.vrHelper.raySelectionPredicate=e=>this.world.isSelectableMesh(e),this.vrHelper.onBeforeCameraTeleport.add((e=>{this.world.camera.globalPosition.x=e.x,this.world.camera.globalPosition.y=e.y,this.world.camera.globalPosition.z=e.z,this.world.terrain&&this.world.terrain.update(!0)}))),console.log("VRHelper initialized",this.vrHelper)}afterTeleportation(){var e=this.vrHelper.baseExperience.camera.position;this.world.camera.globalPosition.x=e.x,this.world.camera.globalPosition.y=e.y,this.world.camera.globalPosition.z=e.z,this.world.terrain&&this.world.terrain.update(!1)}startTracking(){this.world.scene.registerBeforeRender(this.tracker)}stopTracking(){this.world.scene.unregisterBeforeRender(this.tracker)}camera(){return this.vrHelper.input.xrCamera}addFloorMesh(e){this.vrHelper&&this.vrHelper.teleportation&&e&&(this.vrHelper.teleportation.removeFloorMesh(e),this.vrHelper.teleportation.addFloorMesh(e))}removeFloorMesh(e){this.vrHelper&&this.vrHelper.teleportation&&this.vrHelper.teleportation.removeFloorMesh(e)}raySelectionPredicate(e){var t=this.vrHelper.pointerSelection.raySelectionPredicate;return e&&(this.vrHelper.pointerSelection.raySelectionPredicate=e),t}clearFloors(){for(var e=0;e<this.world.getFloorMeshes().length;e++)this.removeFloorMesh(this.world.getFloorMeshes()[e])}addFloors(){for(var e=0;e<this.world.getFloorMeshes().length;e++)this.addFloorMesh(this.world.getFloorMeshes()[e])}}class O{async init(e,t,i,s,o,n){return this.canvas=e.getInputElement(),this.engine=e,this.name=t,this.scene=i,this.vrHelper=null,n?this.file=n:this.file||(this.file="scene.gltf"),o?this.baseUrl=o:this.baseUrl||(this.baseUrl=""),this.gravityEnabled=!0,this.collisionsEnabled=!0,await this.createScene(e),this.onProgress||(this.indicator=B.loadProgressIndicator(this.scene,this.camera),this.onProgress=(e,t)=>this.indicator.progress(e,t)),this.registerRenderLoop(),this.createTerrain(),this.load(s),this.scene}async createScene(e){this.scene||(this.scene=new BABYLON.Scene(e));var t=await this.createCamera();t&&(this.camera=t),this.attachControl();var i=await this.createLights();i&&(this.light=i);var s=await this.createShadows();s&&(this.shadowGenerator=s);var o=await this.createSkyBox();o&&(this.skyBox=o);var n=await this.createGround();n&&(this.ground=n),await this.createEffects(),await this.createPhysics()}async createCamera(){alert("Please override createCamera() method")}async createLights(){}async createShadows(){}async createSkyBox(){}async createGround(){}async createEffects(){}async createPhysics(){}async createTerrain(){}attachControl(){this.camera.attachControl(this.canvas,!0)}universalCamera(e,t){t||(t="UniversalCamera");var i=new BABYLON.UniversalCamera(t,e,this.scene);return i.maxZ=1e5,i.minZ=0,i.applyGravity=!0,i.speed=.2,i.ellipsoid=new BABYLON.Vector3(.5,.9,.5),i.ellipsoidOffset=new BABYLON.Vector3(0,.2,0),i.checkCollisions=!0,i.keysDown=[40,83],i.keysLeft=[37,65],i.keysRight=[39,68],i.keysUp=[38,87],i.keysUpward=[36,33,32],i}async dispose(){this.camera&&(this.camera.dispose(),this.camera=null),this.skyBox&&(this.skyBox.dispose(),this.skyBox.material.dispose(),this.skyBox=null),this.light&&(this.light.dispose(),this.light=null),this.shadowGenerator&&(this.shadowGenerator.dispose(),this.shadowGenerator=null)}initXR(e){e&&(this.vrHelper=e),this.vrHelper||(this.vrHelper=new x),this.vrHelper.initXR(this)}trackXrDevices(){}isSelectableMesh(e){return this.floorMeshes&&this.floorMeshes.includes(e)}getFloorMeshes(){return this.floorMeshes?this.floorMeshes:[]}collisions(e){this._collisions(this.floorMeshes,this.collisionsEnabled&&e),this._collisions(this.sceneMeshes,this.collisionsEnabled&&e),this.camera.applyGravity=this.gravityEnabled&&e,this.camera._needMoveForGravity=this.gravityEnabled&&e}_collisions(e,t){if(e)for(var i=0;i<e.length;i++)this.setMeshCollisions(e[i],t)}setMeshCollisions(e,t){e.checkCollisions=t}loadProgress(e,t){this.onProgress&&this.onProgress(e,t)}loadingStart(e){this.indicator&&this.indicator.add(e)}loadingStop(e){this.indicator&&this.indicator.remove(e)}load(e){return this.loadingStart(this.name),BABYLON.SceneLoader.LoadAssetContainer(this.baseUrl,this.file,this.scene,(t=>{this.sceneMeshes=t.meshes,this.container=t;var i=t.createRootMesh();i.name=this.name,t.addAllToScene(),this.loaded(this.file,i),B.log("World loaded"),this.loadingStop(this.name),this.collisions(this.collisionsEnabled),e&&e(this)}),(e=>{this.loadProgress(e,name)})),this}loaded(e,t){this.initXR()}optimizeScene(){B.optimizeScene(this.scene)}registerRenderLoop(){var e=()=>{this.scene?this.scene.render():this.engine.stopRenderLoop(e)};this.engine.runRenderLoop(e)}async loadAsset(e,t,i){return BABYLON.SceneLoader.LoadAssetContainerAsync(this.assetPath(e),t,i)}assetPath(e){return this.baseUrl+e}}class N{constructor(e,t){this.world=e,this.scene=e.scene,this.resolution=.01,this.customOptions=null,this.trackRotation=!0,this.mesh=null,this.mediaStreams=null,this.changeCallback=null,this.avatarFactory=this.createAvatar,this.defaultPosition=new BABYLON.Vector3(1e3,1e3,1e3),this.defaultRotation=new BABYLON.Vector3(0,0,0),this.scene.activeCamera?this.trackCamera():console.log("Undefined camera in WorldManager, tracking disabled"),this.scene.onActiveCameraChanged.add((()=>{this.trackCamera()})),this.VRSPACE=u,this.fps=t||5,this.pos={x:null,y:null,z:null},this.rot={x:null,y:null,z:null},this.leftArmPos={x:null,y:null,z:null},this.rightArmPos={x:null,y:null,z:null},this.leftArmRot={x:null,y:null,z:null,w:null},this.rightArmRot={x:null,y:null,z:null,w:null},this.interval=null,u.addWelcomeListener((e=>this.setSessionStatus(!0))),u.addSceneListener((e=>this.sceneChanged(e))),this.debug=!1}pubSub(e,t){this.log("Subscribing as client "+e.id+" with token "+e.token),e.token&&this.mediaStreams&&(t&&(this.mediaStreams.startVideo=!0,this.mediaStreams.videoSource=void 0),this.mediaStreams.connect(e.token).then((()=>this.mediaStreams.publish())))}log(e){this.debug&&console.log(e)}trackMesh(e){e?this.log("Tracking mesh "+e.id):this.mesh&&this.log("Stopped tracking mesh "+this.mesh.id),this.mesh=e}trackCamera(e){e||(e=this.scene.activeCamera),e&&(this.log("Tracking camera "+e.getClassName()),this.camera=e)}setSessionStatus(e){this.log("Session status: "+e),e?this.interval||(this.interval=setInterval((()=>this.trackChanges()),1e3/this.fps)):this.interval&&(clearInterval(this.interval),this.interval=null)}isOnline(){return null!=this.interval}sceneChanged(e){null!=e.added?(this.log("ADDED "+e.objectId+" new size "+e.scene.size),this.log(e),e.added.hasAvatar&&e.added.hasAvatar()?this.loadAvatar(e.added):"video"===e.added.mesh?this.loadStream(e.added):e.added.mesh?this.loadMesh(e.added):console.log("WARNING: can't load "+e.objectId+" - no mesh")):null!=e.removed?(this.log("REMOVED "+e.objectId+" new size "+e.scene.size),this.removeMesh(e.removed)):this.log("ERROR: invalid scene event")}createAvatar(e){return new R(this.scene,null,this.customOptions)}loadStream(e){this.log("loading stream for "+e.id);var t=this.avatarFactory(e);t.autoStart=!1,t.autoAttach=!1,e.name?t.altText=e.name:t.altText="u"+e.id,t.show(),t.mesh.name=e.mesh,t.mesh.id=e.className+" "+e.id,e.video=t;var i=new BABYLON.TransformNode("Root of "+t.mesh.id,this.scene);t.mesh.parent=i,i.VRObject=e,this.log("Added stream "+e.id),0==e.position.x&&0==e.position.y&&0==e.position.z?(i.position=new BABYLON.Vector3(this.defaultPosition.x,this.defaultPosition.y,this.defaultPosition.z),e.position=this.defaultPosition,this.changeObject(e,{position:{}},i)):i.position=new BABYLON.Vector3(e.position.x,e.position.y,e.position.z),e.rotation&&(0==e.rotation.x&&0==e.rotation.y&&0==e.rotation.z?(i.rotation=new BABYLON.Vector3(this.defaultRotation.x,this.defaultRotation.y,this.defaultRotation.z),e.rotation=this.defaultRotation,this.changeObject(e,{rotation:{}},i)):i.rotation=new BABYLON.Vector3(e.rotation.x,e.rotation.y,e.rotation.z)),e.addListener(((e,t)=>this.changeObject(e,t,i))),this.mediaStreams?this.mediaStreams.streamToMesh(e,t.mesh):console.log("WARNING: unable to stream to "+e.id+" - no MediaStreams")}loadAvatar(e){this.log("loading avatar "+e.mesh);var t=e.mesh.lastIndexOf("/"),i=e.mesh.substring(0,t);e.mesh.substring(t+1),t=i.lastIndexOf("/");var s=i.substring(0,t+1),o=i.substring(t+1),n=(o=new f(s,o,null),new g(this.scene,o));n.fps=this.fps,n.userHeight=e.userHeight,n.debug=!0,n.load((t=>{e.container=t,t.VRObject=e,this.changeAvatar(e,{position:e.position}),e.rotation&&this.changeAvatar(e,{rotation:e.rotation}),e.addListener(((e,t)=>this.changeAvatar(e,t))),this.mediaStreams&&this.mediaStreams.streamToMesh(e,e.container.rootMesh)}))}changeAvatar(e,t){this.log("Processing changes on avatar"),this.log(t);var i=e.container;for(var s in t){var o=i.rootMesh;if("position"===s)e.translate||(e.translate=B.createAnimation(o,"position",this.fps)),B.updateAnimation(e.translate,o.position,e.position);else if("rotation"===s)e.rotate||(e.rotate=B.createQuaternionAnimation(o,"rotationQuaternion",this.fps)),B.updateQuaternionAnimation(e.rotate,o.rotationQuaternion,e.rotation);else if("leftArmPos"===s){var n=new BABYLON.Vector3(e.leftArmPos.x,e.leftArmPos.y,e.leftArmPos.z);i.reachFor(i.body.rightArm,n)}else"rightArmPos"===s?(n=new BABYLON.Vector3(e.rightArmPos.x,e.rightArmPos.y,e.rightArmPos.z),i.reachFor(i.body.leftArm,n)):"leftArmRot"===s?i.body.leftArm.pointerQuat=new BABYLON.Quaternion(e.rightArmRot.x,e.rightArmRot.y,e.rightArmRot.z,e.rightArmRot.w):"rightArmRot"===s&&(i.body.rightArm.pointerQuat=new BABYLON.Quaternion(e.leftArmRot.x,e.leftArmRot.y,e.leftArmRot.z,e.leftArmRot.w))}}loadMesh(e){if(this.log("Loading object "+e.mesh),e.mesh){var t=e.mesh.lastIndexOf("/"),i=e.mesh.substring(0,t+1),s=e.mesh.substring(t+1);BABYLON.SceneLoader.LoadAssetContainerAsync(i,s,this.scene).then((t=>{this.log("loaded "+e.mesh),this.boundingBox(t);var i=t.createRootMesh();i.VRObject=e,i.name=e.mesh,i.id=e.className+" "+e.id,t.addAllToScene(),e.container=t,this.log("Added "+e.mesh),this.changeObject(e,{position:{}}),e.addListener(((e,t)=>this.changeObject(e,t)))}))}else console.log("Null mesh of client "+e.id)}boundingBox(e){for(var t=new BABYLON.Vector3(0,0,0),i=0;i<e.meshes.length;i++){e.meshes[i].refreshBoundingInfo();var s=e.meshes[i].getBoundingInfo().boundingBox;console.log("max: "+s.maximumWorld+" min: "+s.minimumWorld);var o=new BABYLON.Vector3(s.maximumWorld.x-s.minimumWorld.x,s.maximumWorld.y-s.minimumWorld.y,s.maximumWorld.z-s.minimumWorld.z);t.x=Math.max(t.x,o.x),t.y=Math.max(t.y,o.y),t.z=Math.max(t.z,o.z)}return console.log("BBoxMax: "+t),t}changeObject(e,t,i){for(var s in this.log("Changes on "+e.id+": "+JSON.stringify(t)),i||(i=e.container.meshes[0]),t)"position"===s?(e.translate||(e.translate=B.createAnimation(i,"position",this.fps)),B.updateAnimation(e.translate,i.position,e.position)):"rotation"===s?(e.rotate||(e.rotate=B.createAnimation(i,"rotation",this.fps)),B.updateAnimation(e.rotate,i.rotation,e.rotation)):this.routeEvent(e,s,i)}routeEvent(e,t,i){var s=e;if(e.container)s=e.container;else{if(!e.video)return void console.log("Ignoring unknown event "+t+" to object "+e.id);s=e.video}"function"==typeof s[t]?s[t](e):"function"==typeof e[t+"Changed"]?e[t+"Changed"](e):console.log("Ignoring unknown event to "+e+": "+t)}removeMesh(e){this.mediaStreams&&this.mediaStreams.removeClient(e),e.container&&(e.container.dispose(),e.container=null),e.video&&(e.video.dispose(),e.video=null),e.translate&&(e.translate.dispose(),e.translate=null),e.rotate&&(e.rotate.dispose(),e.rotate=null),e.streamToMesh&&(e.streamToMesh.dispose(),e.streamToMesh=null)}trackChanges(){var e=[];if(this.mesh){var t=this.mesh.position;if(this.mesh.ellipsoid){var i=this.mesh.position.y-this.mesh.ellipsoid.y;t=new BABYLON.Vector3(this.mesh.position.x,i,this.mesh.position.z)}this.checkChange("position",this.pos,t,e),this.checkChange("rotation",this.rot,this.mesh.rotation,e)}else{if(!this.camera)return;if(this.camera.ellipsoid?(i=this.camera.globalPosition.y-2*this.camera.ellipsoid.y,this.camera.ellipsoidOffset&&(i+=this.camera.ellipsoidOffset.y),this.checkChange("position",this.pos,new BABYLON.Vector3(this.camera.globalPosition.x,i,this.camera.globalPosition.z),e)):this.checkChange("position",this.pos,this.camera.globalPosition,e),this.trackRotation){var s=this.camera.rotation;"WebXRCamera"==this.camera.getClassName()&&(s=this.camera.rotationQuaternion.toEulerAngles()),this.checkChange("rotation",this.rot,s,e)}var o=this.world.vrHelper;o&&o.leftController&&(this.checkChange("leftArmPos",this.leftArmPos,o.leftController.grip.absolutePosition,e),this.checkChange("leftArmRot",this.leftArmRot,o.leftController.pointer.rotationQuaternion,e)),o&&o.rightController&&(this.checkChange("rightArmPos",this.rightArmPos,o.rightController.grip.absolutePosition,e),this.checkChange("rightArmRot",this.rightArmRot,o.rightController.pointer.rotationQuaternion,e))}e.length>0&&(u.sendMyChanges(e),this.changeCallback&&this.changeCallback(e))}checkChange(e,t,i,s){(this.isChanged(t.x,i.x,this.resolution)||this.isChanged(t.y,i.y,this.resolution)||this.isChanged(t.z,i.z,this.resolution))&&(this.log(Date.now()+": "+e+" changed, sending "+i),t.x=i.x,t.y=i.y,t.z=i.z,s.push({field:e,value:i}))}isChanged(e,t,i){return t<e-i||t>e+i}async enter(e){return new Promise(((t,i)=>{var s=e=>{u.removeWelcomeListener(s),t(e)},o=i=>{if(u.removeWelcomeListener(o),e)for(var n in e)u.sendMy(n,e[n]);this.world.name?(u.addWelcomeListener(s),u.sendCommand("Enter",{world:this.world.name}),u.sendCommand("Session")):(u.sendCommand("Session"),t(i))};this.isOnline()?this.world.name&&(u.addWelcomeListener(s),u.sendCommand("Enter",{world:this.world.name})):(u.addWelcomeListener(o),u.connect(this.world.serverUrl))}))}}class M{constructor(e,t){this.scene=e,this.htmlElementName=t,this.startAudio=!0,this.startVideo=!1,this.audioSource=void 0,this.videoSource=!1,this.publisher=null,this.clients=[],this.subscribers=[]}async init(e){throw"implement me!"}async connect(e){return e=e.replaceAll("&amp;","&"),console.log("token: "+e),await this.init((e=>this.streamingStart(e))),this.session.connect(e)}publish(e){this.publisher=this.OV.initPublisher(e,{videoSource:this.videoSource,audioSource:this.audioSource,publishAudio:this.startAudio,publishVideo:this.startVideo}),this.publisher.on("videoElementCreated",(e=>{console.log("Video element created:"),console.log(e.element),e.element.muted=!0})),e&&this.publisher.subscribeToRemote(),this.session.publish(this.publisher),console.log("Publishing to connection "+this.publisher.stream.connection.connectionId),console.log(this.publisher)}publishVideo(e){this.publisher&&(console.log("Publishing video: "+e),this.publisher.publishVideo(e))}publishAudio(e){this.publisher&&(console.log("Publishing audio: "+e),this.publisher.publishAudio(e))}getClientId(e){return parseInt(e.stream.connection.data,10)}getStream(e){return e.stream.getMediaStream()}removeClient(e){for(var t=0;t<this.clients.length;t++)if(this.clients[t].id==e.id){this.clients.splice(t,1),console.log("Removed client "+e.id);break}var i=this.subscribers.length;this.subscribers=this.subscribers.filter((t=>this.getClientId(t)!=e.id)),console.log("Removed "+(i-this.subscribers.length)+" subscribers, new size "+this.subscribers.length)}streamingStart(e){var t=this.getClientId(e);console.log("Stream started for client "+t);for(var i=0;i<this.clients.length;i++){var s=this.clients[i];if(s.id==t){this.attachAudioStream(s.streamToMesh,this.getStream(e)),console.log("Audio/video stream started for avatar of client "+t),this.attachVideoStream(s,e);break}}this.subscribers.push(e)}streamToMesh(e,t){console.log("Loaded avatar of client "+e.id),e.streamToMesh=t;for(var i=0;i<this.subscribers.length;i++){var s=this.subscribers[i],o=this.getClientId(s);e.id==o&&(this.attachAudioStream(t,this.getStream(s)),this.attachVideoStream(e,s),console.log("Audio/video stream connected to avatar of client "+o))}this.clients.push(e)}attachAudioStream(e,t){var i=t.getAudioTracks();if(i&&i.length>0){console.log("Attaching audio stream to mesh "+e.id);var s=new BABYLON.Sound("voice",t,this.scene,null,{loop:!1,autoplay:!0,spatialSound:!0,streaming:!0,distanceModel:"linear",maxDistance:50,panningModel:"equalpower"});s.attachToMesh(e);var o=s._inputAudioNode.context,n=s.getSoundGain();s._streamingSource.connect(s._soundPanner),s._soundPanner.connect(n),n.connect(o.destination)}}attachVideoStream(e,t){if(e.video){var i=t.stream.getMediaStream();t.stream.hasVideo&&t.stream.videoActive&&(console.log("Streaming video texture"),e.video.displayStream(i)),t.on("streamPropertyChanged",(t=>{console.log("Stream property changed: "),console.log(t),"videoActive"===t.changedProperty&&(t.newValue&&t.stream.hasVideo?e.video.displayStream(i):e.video.displayAlt())}))}}}class R{constructor(e,t,i){if(this.scene=e,this.callback=t,this.deviceId=null,this.radius=1,this.altText="N/A",this.altImage=null,this.textStyle="bold 64px monospace",this.textColor="black",this.backColor="white",this.maxWidth=640,this.maxHeight=640,this.autoStart=!0,this.autoAttach=!0,this.attached=!1,i)for(var s of Object.keys(i))this[s]=i[s]}async show(){this.mesh||(this.autoAttach&&(this.cameraTracker=()=>this.cameraChanged()),this.mesh=BABYLON.MeshBuilder.CreateDisc("VideoAvatar",{radius:this.radius},this.scene),this.mesh.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL,this.mesh.position=new BABYLON.Vector3(0,this.radius,0),this.mesh.material=new BABYLON.StandardMaterial("WebCamMat",this.scene),this.mesh.material.emissiveColor=new BABYLON.Color3.White,this.mesh.material.specularColor=new BABYLON.Color3.Black,this.mesh.ellipsoid=new BABYLON.Vector3(this.radius,this.radius,this.radius),this.scene.effectLayers&&this.scene.effectLayers.forEach((e=>{"GlowLayer"===e.getClassName()&&e.addExcludedMesh(this.mesh)})),this.displayAlt(),this.autoStart&&await this.displayVideo())}dispose(){this.mesh.parent&&this.mesh.parent.dispose(),this.mesh.material&&(this.mesh.material.diffuseTexture&&this.mesh.material.diffuseTexture.dispose(),this.mesh.material.dispose()),this.mesh&&(this.mesh.dispose(),delete this.mesh)}displayText(e){e&&(this.altText=e),this.mesh.material.diffuseTexture&&this.mesh.material.diffuseTexture.dispose(),this.mesh.material.diffuseTexture=new BABYLON.DynamicTexture("WebCamTexture",{width:128,height:128},this.scene),this.mesh.material.diffuseTexture.drawText(this.altText,null,null,this.textStyle,this.textColor,this.backColor,!1,!0)}displayImage(e){e&&(this.altImage=e),this.mesh.material.diffuseTexture&&this.mesh.material.diffuseTexture.dispose(),this.mesh.material.diffuseTexture=new BABYLON.Texture(this.altImage,this.scene,null,!1)}displayAlt(){this.altImage?this.displayImage():this.displayText()}async displayVideo(e){if(e&&(this.deviceId=e),!this.deviceId)for(var t=await navigator.mediaDevices.enumerateDevices(),i=0;i<t.length;++i)if("videoinput"===t[i].kind){console.log(t[i]),this.deviceId=t[i].deviceId;break}this.deviceId&&BABYLON.VideoTexture.CreateFromWebCamAsync(this.scene,{maxWidth:this.maxWidth,maxHeight:this.maxHeight,deviceId:this.deviceId}).then((e=>{this.mesh.material.diffuseTexture&&this.mesh.material.diffuseTexture.dispose(),this.mesh.material.diffuseTexture=e,this.callback&&this.callback()}))}displayStream(e){BABYLON.VideoTexture.CreateFromStreamAsync(this.scene,e).then((e=>{this.mesh.material.diffuseTexture&&this.mesh.material.diffuseTexture.dispose(),this.mesh.material.diffuseTexture=e}))}attachToCamera(e){if(this.mesh.billboardMode=BABYLON.Mesh.BILLBOARDMODE_NONE,this.mesh.parent=this.camera,e)this.mesh.position=e;else{this.mesh.position=new BABYLON.Vector3(0,-.05,.35);var t=this.radius/2/20;this.mesh.scaling=new BABYLON.Vector3(t,t,t)}this.cameraChanged(),this.attached=!0,this.scene.onActiveCameraChanged.add(this.cameraTracker)}detachFromCamera(){this.attached&&(this.mesh.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL,this.mesh.position=this.camera.position,console.log("Mesh position: "+this.mesh.position),this.mesh.scaling=new BABYLON.Vector3(1,1,1),this.scene.onActiveCameraChanged.remove(this.cameraTracker),this.mesh.parent=null,this.attached=!1)}cameraChanged(){this.autoAttach&&(console.log("Camera changed: "+this.scene.activeCamera.getClassName()+" new position "+this.scene.activeCamera.position),this.camera=this.scene.activeCamera,this.attached=!0,this.mesh.parent=this.camera)}}var P=t.qE,C=t.EK,Y=t.KU,k=t.kE,I=t.UA,S=t.ID,T=t.Mk,V=t.t9,E=t.mx,z=t.E9,Q=t.h_,F=t.$E,j=t.mi,U=t.yN,G=t.Tk,D=t.zW,H=t.VJ,W=t.Jh,_=t.TG,X=t.Rd,J=t.I3,K=t.mj,Z=t.yr,q=t.Lt,$=t.q3,ee=t.dv;export{P as Avatar,C as Buttons,Y as Client,k as EventRecorder,I as FloorRibbon,S as ID,T as LoadProgressIndicator,V as LogoRoom,E as MediaStreams,z as Point,Q as Portal,F as RecorderUI,j as Rotation,U as SceneEvent,G as SceneProperties,D as ServerFolder,H as VREvent,W as VRHelper,_ as VRObject,X as VRSPACE,J as VRSPACEUI,K as VRSpace,Z as VRSpaceUI,q as VideoAvatar,$ as World,ee as WorldManager};